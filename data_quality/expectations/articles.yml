name: articles
class_name: Expectation
module_name: great_expectations.dataset
expectation_suite_name: articles

expectations:
  # Required fields from Avro contract
  - expectation_type: expect_column_to_exist
    kwargs:
      column: article_id
    meta:
      source: avro_contract
      field: article_id
      required: true

  - expectation_type: expect_column_to_exist
    kwargs:
      column: source_id
    meta:
      source: avro_contract
      field: source_id
      required: true

  - expectation_type: expect_column_to_exist
    kwargs:
      column: url
    meta:
      source: avro_contract
      field: url
      required: true

  - expectation_type: expect_column_to_exist
    kwargs:
      column: language
    meta:
      source: avro_contract
      field: language
      required: true

  - expectation_type: expect_column_to_exist
    kwargs:
      column: published_at
    meta:
      source: avro_contract
      field: published_at
      required: true

  - expectation_type: expect_column_to_exist
    kwargs:
      column: ingested_at
    meta:
      source: avro_contract
      field: ingested_at
      required: true

  # Type constraints from Avro contract
  - expectation_type: expect_column_values_to_be_of_type
    kwargs:
      column: article_id
      type_: str
    meta:
      source: avro_contract
      type_constraint: string

  - expectation_type: expect_column_values_to_be_of_type
    kwargs:
      column: source_id
      type_: str
    meta:
      source: avro_contract
      type_constraint: string

  - expectation_type: expect_column_values_to_be_of_type
    kwargs:
      column: url
      type_: str
    meta:
      source: avro_contract
      type_constraint: string

  - expectation_type: expect_column_values_to_be_of_type
    kwargs:
      column: language
      type_: str
    meta:
      source: avro_contract
      type_constraint: string

  # Non-null constraints for required fields
  - expectation_type: expect_column_values_to_not_be_null
    kwargs:
      column: article_id
    meta:
      source: avro_contract
      constraint: non_null_required

  - expectation_type: expect_column_values_to_not_be_null
    kwargs:
      column: source_id
    meta:
      source: avro_contract
      constraint: non_null_required

  - expectation_type: expect_column_values_to_not_be_null
    kwargs:
      column: url
    meta:
      source: avro_contract
      constraint: non_null_required

  - expectation_type: expect_column_values_to_not_be_null
    kwargs:
      column: language
    meta:
      source: avro_contract
      constraint: non_null_required

  - expectation_type: expect_column_values_to_not_be_null
    kwargs:
      column: published_at
    meta:
      source: avro_contract
      constraint: non_null_required

  - expectation_type: expect_column_values_to_not_be_null
    kwargs:
      column: ingested_at
    meta:
      source: avro_contract
      constraint: non_null_required

  # Business logic constraints
  - expectation_type: expect_column_values_to_match_regex
    kwargs:
      column: language
      regex: ^[a-z]{2}$
    meta:
      source: avro_contract
      constraint: iso_639_1_format
      description: "Language must be ISO 639-1 code (2 lowercase letters)"

  - expectation_type: expect_column_values_to_match_regex
    kwargs:
      column: country
      regex: ^[A-Z]{2}$
    meta:
      source: avro_contract
      constraint: iso_3166_1_format
      description: "Country must be ISO 3166-1 alpha-2 code (2 uppercase letters)"
    
  # URL format validation
  - expectation_type: expect_column_values_to_match_regex
    kwargs:
      column: url
      regex: ^https?://.*
    meta:
      source: avro_contract
      constraint: url_format
      description: "URL must start with http:// or https://"

  # Sentiment score range constraint from Avro contract
  - expectation_type: expect_column_values_to_be_between
    kwargs:
      column: sentiment_score
      min_value: -1.0
      max_value: 1.0
    meta:
      source: avro_contract
      constraint: sentiment_range
      description: "Sentiment score must be between -1 (negative) and 1 (positive)"

  # Timestamp constraints - ingested_at should be >= published_at
  # Note: Column pair comparison is not available in this GX version
  # This would need to be implemented as custom business logic validation

  # Recent data quality checks
  - expectation_type: expect_column_values_to_be_between
    kwargs:
      column: published_at
      min_value: 946684800000  # 2000-01-01 in milliseconds
      max_value: null  # No upper bound - current timestamp checked at runtime
    meta:
      source: business_logic
      constraint: reasonable_published_date
      description: "Published date should not be before year 2000"

  - expectation_type: expect_column_values_to_be_between
    kwargs:
      column: ingested_at
      min_value: 946684800000  # 2000-01-01 in milliseconds
      max_value: null  # No upper bound - current timestamp checked at runtime
    meta:
      source: business_logic
      constraint: reasonable_ingested_date
      description: "Ingested date should not be before year 2000"

  # Data completeness checks (nullable fields should have reasonable non-null rates)
  - expectation_type: expect_column_values_to_not_be_null
    kwargs:
      column: title
      mostly: 0.95  # 95% of articles should have titles
    meta:
      source: data_quality
      constraint: title_completeness
      description: "95% of articles should have non-null titles"

  - expectation_type: expect_column_values_to_not_be_null
    kwargs:
      column: body
      mostly: 0.90  # 90% of articles should have body content
    meta:
      source: data_quality
      constraint: body_completeness
      description: "90% of articles should have non-null body content"

  # String length constraints
  - expectation_type: expect_column_value_lengths_to_be_between
    kwargs:
      column: article_id
      min_value: 1
      max_value: 255
    meta:
      source: data_quality
      constraint: article_id_length
      description: "Article ID should be between 1 and 255 characters"

  - expectation_type: expect_column_value_lengths_to_be_between
    kwargs:
      column: source_id
      min_value: 1
      max_value: 100
    meta:
      source: data_quality
      constraint: source_id_length
      description: "Source ID should be between 1 and 100 characters"

  - expectation_type: expect_column_value_lengths_to_be_between
    kwargs:
      column: title
      min_value: 1
      max_value: 500
    meta:
      source: data_quality
      constraint: title_length
      description: "Title should be between 1 and 500 characters when not null"

  # Array constraints for topics field
  - expectation_type: expect_column_values_to_be_of_type
    kwargs:
      column: topics
      type_: list
    meta:
      source: avro_contract
      type_constraint: array

meta:
  generated_from: contracts/schemas/avro/article-ingest-v1.avsc
  contract_version: v1
  suite_purpose: validate_article_ingest_against_avro_contract
  last_updated: "2025-08-28"
  maintainer: data-platform-team
