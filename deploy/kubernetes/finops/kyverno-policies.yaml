apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: require-finops-labels
  annotations:
    policies.kyverno.io/title: "Require FinOps Cost Allocation Labels"
    policies.kyverno.io/category: "FinOps, Governance"
    policies.kyverno.io/severity: "medium"
    policies.kyverno.io/subject: "Pod, Deployment, StatefulSet, Job, CronJob"
    policies.kyverno.io/minversion: "1.6.0"
    policies.kyverno.io/description: >-
      This policy ensures that all workloads have the required FinOps 
      cost allocation labels for proper cost attribution and governance.
      Required labels: app, component, pipeline, team, env, cost_center.
spec:
  validationFailureAction: enforce
  background: true
  rules:
  - name: require-finops-labels-on-workloads
    match:
      any:
      - resources:
          kinds:
          - Pod
          - Deployment
          - StatefulSet
          - Job
          - CronJob
          - DaemonSet
          - ReplicaSet
          namespaces:
          - neuronews
          - monitoring
          - opencost
          - data-processing
          - ml-workloads
    exclude:
      any:
      - resources:
          namespaces:
          - kube-system
          - kube-public
          - kube-node-lease
          - kyverno
          - cert-manager
    validate:
      message: >-
        FinOps cost allocation labels are required. Missing labels: app, component, 
        pipeline, team, env, cost_center. See docs/finops/labels.md for guidance.
      pattern:
        metadata:
          labels:
            app: "?*"
            component: "?*" 
            pipeline: "ingest|transform|dbt|api|rag|monitoring|infra"
            team: "?*"
            env: "dev|staging|prod|test"
            cost_center: "?*"

---
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: validate-finops-label-values
  annotations:
    policies.kyverno.io/title: "Validate FinOps Label Values"
    policies.kyverno.io/category: "FinOps, Governance"
    policies.kyverno.io/severity: "medium"
    policies.kyverno.io/description: >-
      This policy validates that FinOps labels contain valid values
      according to the organization's cost allocation schema.
spec:
  validationFailureAction: enforce
  background: true
  rules:
  - name: validate-pipeline-values
    match:
      any:
      - resources:
          kinds:
          - Pod
          - Deployment
          - StatefulSet
          - Job
          - CronJob
          - DaemonSet
          - ReplicaSet
    exclude:
      any:
      - resources:
          namespaces:
          - kube-system
          - kube-public
          - kube-node-lease
          - kyverno
          - cert-manager
    validate:
      message: >-
        Invalid pipeline label value. Allowed values: ingest, transform, dbt, 
        api, rag, monitoring, infra
      pattern:
        metadata:
          labels:
            pipeline: "ingest|transform|dbt|api|rag|monitoring|infra"
  
  - name: validate-env-values
    match:
      any:
      - resources:
          kinds:
          - Pod
          - Deployment
          - StatefulSet
          - Job
          - CronJob
          - DaemonSet
          - ReplicaSet
    exclude:
      any:
      - resources:
          namespaces:
          - kube-system
          - kube-public
          - kube-node-lease
          - kyverno
          - cert-manager
    validate:
      message: >-
        Invalid env label value. Allowed values: dev, staging, prod, test
      pattern:
        metadata:
          labels:
            env: "dev|staging|prod|test"

---
apiVersion: kyverno.io/v1
kind: ClusterPolicy  
metadata:
  name: generate-missing-finops-labels
  annotations:
    policies.kyverno.io/title: "Generate Missing FinOps Labels"
    policies.kyverno.io/category: "FinOps, Other"
    policies.kyverno.io/severity: "low"
    policies.kyverno.io/description: >-
      This policy automatically generates default FinOps labels for resources
      that don't have them, based on namespace and resource patterns.
spec:
  background: true
  rules:
  - name: generate-default-labels-monitoring
    match:
      any:
      - resources:
          kinds:
          - Pod
          - Deployment
          - StatefulSet
          namespaces:
          - monitoring
    exclude:
      any:
      - resources:
          kinds:
          - Pod
          - Deployment  
          - StatefulSet
        clusterRoles:
        - "system:*"
    mutate:
      patchStrategicMerge:
        metadata:
          labels:
            +(pipeline): "monitoring"
            +(team): "platform"
            +(env): "prod"
            +(cost_center): "infrastructure"
            
  - name: generate-default-labels-neuronews
    match:
      any:
      - resources:
          kinds:
          - Pod
          - Deployment
          - StatefulSet
          namespaces:
          - neuronews
    mutate:
      patchStrategicMerge:
        metadata:
          labels:
            +(team): "neuronews"
            +(env): "prod"
            +(cost_center): "product"
