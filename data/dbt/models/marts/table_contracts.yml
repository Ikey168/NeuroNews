version: 2

# Iceberg Table Contracts for Data Warehouse Layer
# Issue #372: Assert table schema, partition spec, and table properties

models:
  - name: fact_articles
    description: "Fact table for articles with enforced Iceberg table contracts"
    config:
      contract:
        enforced: true
      # Iceberg-specific contract assertions
      table_format: iceberg
      expected_partition_spec:
        - field: year
          transform: identity
          type: int
        - field: month
          transform: identity
          type: int
      expected_table_properties:
        "write.format.default": "parquet"
        "write.parquet.compression-codec": "snappy"
        "history.expire.max-snapshot-age-ms": "432000000"
        "history.expire.min-snapshots-to-keep": "5"
        "delete.mode": "merge-on-read"
    columns:
      - name: article_id
        description: "Unique identifier for the article"
        data_type: string
        constraints:
          - type: not_null
          - type: unique
      - name: url
        description: "Original URL of the article"
        data_type: string
        constraints:
          - type: not_null
      - name: title
        description: "Article title"
        data_type: string
        constraints:
          - type: not_null
      - name: content
        description: "Full article content"
        data_type: string
      - name: summary
        description: "Article summary/excerpt"
        data_type: string
      - name: source
        description: "News source/publisher name"
        data_type: string
        constraints:
          - type: not_null
      - name: category
        description: "Article category"
        data_type: string
      - name: language
        description: "Article language using ISO 639-1 code"
        data_type: string
        constraints:
          - type: not_null
      - name: published_at
        description: "Timestamp when the article was originally published"
        data_type: timestamp
        constraints:
          - type: not_null
      - name: processed_at
        description: "Timestamp when the article was processed"
        data_type: timestamp
        constraints:
          - type: not_null
      - name: is_valid_row
        description: "Boolean indicating if the row passed validation"
        data_type: boolean
        constraints:
          - type: not_null
      - name: hours_since_processed
        description: "Number of hours since the article was processed"
        data_type: double
      - name: year
        description: "Year partition (derived from published_at)"
        data_type: int
        constraints:
          - type: not_null
      - name: month
        description: "Month partition (derived from published_at)"
        data_type: int
        constraints:
          - type: not_null
      - name: day
        description: "Day (derived from published_at)"
        data_type: int
        constraints:
          - type: not_null
      - name: hour
        description: "Hour (derived from published_at)"
        data_type: int
        constraints:
          - type: not_null

  - name: agg_daily_metrics
    description: "Daily aggregated metrics with Iceberg table contracts"
    config:
      contract:
        enforced: true
      table_format: iceberg
      expected_partition_spec:
        - field: date_partition
          transform: identity
          type: date
      expected_table_properties:
        "write.format.default": "parquet"
        "write.parquet.compression-codec": "zstd"
        "delete.mode": "merge-on-read"
    columns:
      - name: date_partition
        description: "Date partition for the aggregated metrics"
        data_type: date
        constraints:
          - type: not_null
      - name: source
        description: "News source"
        data_type: string
        constraints:
          - type: not_null
      - name: language
        description: "Language code"
        data_type: string
        constraints:
          - type: not_null
      - name: total_articles
        description: "Total number of articles for the day"
        data_type: bigint
        constraints:
          - type: not_null
      - name: avg_sentiment_score
        description: "Average sentiment score for the day"
        data_type: double
      - name: processing_time_avg_minutes
        description: "Average processing time in minutes"
        data_type: double

  - name: dim_sources
    description: "Source dimension table with Iceberg contracts"
    config:
      contract:
        enforced: true
      table_format: iceberg
      expected_table_properties:
        "write.format.default": "parquet"
        "write.parquet.compression-codec": "snappy"
        "delete.mode": "copy-on-write"  # Dimension tables use COW for consistency
    columns:
      - name: source_id
        description: "Unique identifier for the news source"
        data_type: string
        constraints:
          - type: not_null
          - type: unique
      - name: source_name
        description: "Human-readable name of the news source"
        data_type: string
        constraints:
          - type: not_null
      - name: source_url
        description: "Base URL of the news source"
        data_type: string
      - name: source_type
        description: "Type of news source (newspaper, blog, wire, etc.)"
        data_type: string
      - name: is_active
        description: "Whether the source is currently active"
        data_type: boolean
        constraints:
          - type: not_null
      - name: created_at
        description: "When the source was first added"
        data_type: timestamp
        constraints:
          - type: not_null
      - name: updated_at
        description: "When the source was last updated"
        data_type: timestamp
        constraints:
          - type: not_null
